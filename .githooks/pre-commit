#!/bin/sh
# Git pre-commit hook: è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ»Lintä¿®æ­£ãƒ»DBå¤‰æ›´ãƒã‚§ãƒƒã‚¯

# ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
STAGED_FILES=$(git diff --cached --name-only)

# TypeScript/JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
TS_JS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx)$' || true)

if [ -n "$TS_JS_FILES" ]; then
  echo "ğŸ”§ è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ»Lintä¿®æ­£ã‚’å®Ÿè¡Œä¸­..."
  
  # Prettierã§è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ï¼‰
  echo "  ğŸ“ Prettierã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¸­..."
  echo "$TS_JS_FILES" | while IFS= read -r file; do
    if [ -f "$file" ]; then
      npx prettier --write "$file" 2>/dev/null || true
    fi
  done
  
  # ESLintã§è‡ªå‹•ä¿®æ­£ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ï¼‰
  echo "  ğŸ” ESLintã§è‡ªå‹•ä¿®æ­£ä¸­..."
  echo "$TS_JS_FILES" | while IFS= read -r file; do
    if [ -f "$file" ]; then
      npx eslint --fix "$file" 2>/dev/null || true
    fi
  done
  
  # ä¿®æ­£ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
  echo "$TS_JS_FILES" | while IFS= read -r file; do
    if [ -f "$file" ]; then
      git add "$file" 2>/dev/null || true
    fi
  done
  
  echo "âœ… è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ»Lintä¿®æ­£ãŒå®Œäº†ã—ã¾ã—ãŸ"
fi

# database.types.tsãŒå¤‰æ›´ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
DB_TYPES_CHANGED=$(echo "$STAGED_FILES" | grep -E "^src/types/database\.types\.ts$" || true)

if [ -n "$DB_TYPES_CHANGED" ]; then
  # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¿½åŠ ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
  NEW_MIGRATIONS=$(echo "$STAGED_FILES" | grep -E "^supabase/migrations/.*\.sql$" || true)
  
  if [ -z "$NEW_MIGRATIONS" ]; then
    echo "âŒ ã‚¨ãƒ©ãƒ¼: DBå¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸãŒã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¿½åŠ ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼"
    echo ""
    echo "src/types/database.types.ts ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸãŒã€supabase/migrations/ ã«æ–°ã—ã„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¿½åŠ ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
    echo ""
    echo "ã€å¯¾å‡¦æ–¹æ³•ã€‘"
    echo "1. MCPã§SQLã‚’å®Ÿè¡Œã—ãŸå ´åˆ:"
    echo "   - Supabase Dashboard > Database > Migrations ã‹ã‚‰æœ€æ–°ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–å¾—"
    echo "   - supabase/migrations/{timestamp}_{name}.sql ã¨ã—ã¦ä¿å­˜"
    echo ""
    echo "2. ã¾ãŸã¯ã€CLIã§å–å¾—:"
    echo "   bash .cursor/load-env.sh sh -c 'npx supabase db pull --linked'"
    echo ""
    echo "3. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°:"
    echo "   git add supabase/migrations/"
    echo ""
    echo "è©³ç´°: docs/SYSTEM.md ã®ã€Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§"
    echo ""
    echo "âš ï¸  ã‚³ãƒŸãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹å ´åˆã¯: git commit --no-verify"
    exit 1
  fi
fi

exit 0


#!/bin/sh
# Git pre-commit hook: 自動フォーマット・Lint修正・DB変更チェック

# ステージングされたファイルをチェック
STAGED_FILES=$(git diff --cached --name-only)

# TypeScript/JavaScriptファイルが変更されたかチェック
TS_JS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx)$' || true)

if [ -n "$TS_JS_FILES" ]; then
  echo "🔧 自動フォーマット・Lint修正を実行中..."
  
  # Prettierで自動フォーマット（ステージングされたファイルのみ）
  echo "  📝 Prettierでフォーマット中..."
  echo "$TS_JS_FILES" | while IFS= read -r file; do
    if [ -f "$file" ]; then
      npx prettier --write "$file" 2>/dev/null || true
    fi
  done
  
  # ESLintで自動修正（ステージングされたファイルのみ）
  echo "  🔍 ESLintで自動修正中..."
  echo "$TS_JS_FILES" | while IFS= read -r file; do
    if [ -f "$file" ]; then
      npx eslint --fix "$file" 2>/dev/null || true
    fi
  done
  
  # 修正されたファイルを再度ステージング
  echo "$TS_JS_FILES" | while IFS= read -r file; do
    if [ -f "$file" ]; then
      git add "$file" 2>/dev/null || true
    fi
  done
  
  echo "✅ 自動フォーマット・Lint修正が完了しました"
fi

# database.types.tsが変更されたかチェック
DB_TYPES_CHANGED=$(echo "$STAGED_FILES" | grep -E "^src/types/database\.types\.ts$" || true)

# Supabase型定義を毎回生成してステージング
if command -v npx >/dev/null 2>&1; then
  echo "🧬 Supabase型定義を生成中..."
  if [ -x ".cursor/load-env.sh" ]; then
    bash .cursor/load-env.sh sh -c 'npx supabase gen types typescript --project-id ucsurbtmhabygssexisq > src/types/database.types.ts'
  else
    npx supabase gen types typescript --project-id ucsurbtmhabygssexisq > src/types/database.types.ts
  fi
  git add src/types/database.types.ts 2>/dev/null || true
fi

# DB型が変わったらマイグレ必須
if [ -n "$DB_TYPES_CHANGED" ]; then
  NEW_MIGRATIONS=$(echo "$STAGED_FILES" | grep -E "^supabase/migrations/.*\.sql$" || true)
  
  if [ -z "$NEW_MIGRATIONS" ]; then
    echo "❌ エラー: DB変更が検出されましたが、マイグレーションファイルが追加されていません！"
    echo ""
    echo "src/types/database.types.ts が変更されましたが、supabase/migrations/ に新しいマイグレーションファイルが追加されていません。"
    echo ""
            echo "【対処方法】"
            echo "1. マイグレーションファイルを作成:"
            echo "   npx supabase migration new migration_name"
            echo ""
            echo "2. SQLを直接書く:"
            echo "   supabase/migrations/{timestamp}_{name}.sql にSQLを記述"
            echo ""
            echo "3. マイグレーションファイルをステージング:"
            echo "   git add supabase/migrations/"
    echo ""
    echo "詳細: docs/SYSTEM.md の「データベースマイグレーション」セクションを参照"
    echo ""
    echo "⚠️  コミットをスキップする場合は: git commit --no-verify"
    exit 1
  fi
fi

# 危険なDDL（DROP/TRUNCATEなど）を含むマイグレーションをブロック
MIGRATION_FILES=$(echo "$STAGED_FILES" | grep -E "^supabase/migrations/.*\.sql$" || true)

if [ -n "$MIGRATION_FILES" ]; then
  DANGEROUS_PATTERN='(^|[[:space:]])(DROP[[:space:]]+(TABLE|VIEW|INDEX|SEQUENCE|FUNCTION|TRIGGER|COLUMN|CONSTRAINT)|TRUNCATE[[:space:]]+TABLE)'
  DANGEROUS_HITS=""

  echo "$MIGRATION_FILES" | while IFS= read -r file; do
    if [ -n "$file" ]; then
      # ステージ済み内容をチェック
      if git show ":$file" | grep -Eqi "$DANGEROUS_PATTERN"; then
        DANGEROUS_HITS="$DANGEROUS_HITS$file\n"
      fi
    fi
  done

  if [ -n "$DANGEROUS_HITS" ]; then
    echo "❌ エラー: 危険なDDLが含まれるマイグレーションを検出しました。"
    printf "対象ファイル:\n$DANGEROUS_HITS"
    echo ""
    echo "【対処例】"
    echo "- カラム名変更は RENAME COLUMN に書き換え（DROP/ADD を避ける）"
    echo "- 不要な TRUNCATE/DROP を削除するかデータ退避を検討"
    echo ""
    echo "⚠️  本当に破壊的変更が必要な場合でも、レビューのうえでコメントを残すなど慎重に対応してください。"
    exit 1
  fi
fi

exit 0

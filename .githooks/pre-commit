#!/bin/sh
# Git pre-commit hook: 自動フォーマット・Lint修正・DB変更チェック

# ステージングされたファイルをチェック
STAGED_FILES=$(git diff --cached --name-only)

# Supabase型定義を毎回生成してステージング（フォーマット前に実行）
# 注意: 型定義はリモート（labio-dev）のスキーマと一致させる必要がある
# ローカル開発では、ローカルSupabaseから生成（開発中の変更を反映）
# CI/CDでは、リモートから生成してコミット（リモートの状態を反映）
if command -v npx >/dev/null 2>&1; then
  echo "🧬 Supabase型定義を生成中..."
  # ローカルSupabaseから型定義を生成（開発中の変更を反映）
  # 出力の最初の行「Connecting to db...」を削除
  # パイプラインの終了ステータス問題を回避するため、一時ファイルを使用
  TEMP_TYPES_FILE=$(mktemp) || exit 1
  trap "rm -f '$TEMP_TYPES_FILE'" EXIT
  
  if npx supabase gen types typescript --local > "$TEMP_TYPES_FILE" 2>&1; then
    # 成功した場合のみ、Connecting to db行を削除して出力
    grep -v "^Connecting to db" "$TEMP_TYPES_FILE" > src/types/database.types.ts
    echo "✅ ローカルSupabaseから型定義を生成しました（開発中の変更を反映）"
    rm -f "$TEMP_TYPES_FILE"
  else
    # ローカルが起動していない場合はリモートから生成（フォールバック）
    echo "⚠️  ローカルSupabaseが起動していないため、リモートから型定義を生成します..."
    rm -f "$TEMP_TYPES_FILE"
    if [ -x ".cursor/load-env.sh" ]; then
      bash .cursor/load-env.sh sh -c 'npx supabase gen types typescript --project-id ucsurbtmhabygssexisq > src/types/database.types.ts'
    else
      npx supabase gen types typescript --project-id ucsurbtmhabygssexisq > src/types/database.types.ts
    fi
  fi
  git add src/types/database.types.ts 2>/dev/null || true
fi

# すべてのPrettier対応ファイルをフォーマット
echo "🔧 自動フォーマット・Lint修正を実行中..."

# Prettierで自動フォーマット（全ファイル）
echo "  📝 Prettierでフォーマット中..."
npx prettier --write . 2>/dev/null || true

# TypeScript/JavaScriptファイルに対してESLintで自動修正
TS_JS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx)$' || true)
if [ -n "$TS_JS_FILES" ]; then
  echo "  🔍 ESLintで自動修正中..."
  npx eslint . --fix 2>/dev/null || true
fi

# 修正されたファイルを再度ステージング（元々ステージングされていたファイルのみ）
# ファイル名にスペースや改行が含まれている場合に対応するため、null区切りで処理
if [ -n "$STAGED_FILES" ]; then
  # 元々ステージングされていたファイルをnull区切りで取得し、再ステージング
  # xargs -0 を使用してnull区切りのファイル名を安全に処理
  # 注意: -r オプションはGNU拡張のため、ifチェックで既に空チェック済み
  git diff --cached --name-only -z | xargs -0 git add 2>/dev/null || true
fi

echo "✅ 自動フォーマット・Lint修正が完了しました"

# 注意: MCPでDBへの書き込みができないため、型定義の変更は必ずマイグレーションファイルと一緒にコミットされる
# 型定義の変更チェックは不要（マイグレーションファイルなしで型定義が変わることはない）

# 危険なDDL（DROP/TRUNCATEなど）を含むマイグレーションをブロック
MIGRATION_FILES=$(echo "$STAGED_FILES" | grep -E "^supabase/migrations/.*\.sql$" || true)

if [ -n "$MIGRATION_FILES" ]; then
  DANGEROUS_PATTERN='(^|[[:space:]])(DROP[[:space:]]+(TABLE|VIEW|INDEX|SEQUENCE|FUNCTION|TRIGGER|COLUMN|CONSTRAINT)|TRUNCATE[[:space:]]+TABLE)'
  
  # パイプを使わず、一時ファイルでサブシェル問題を回避
  TEMP_FILE=$(mktemp) || exit 1
  trap "rm -f '$TEMP_FILE'" EXIT

  echo "$MIGRATION_FILES" | while IFS= read -r file; do
    if [ -n "$file" ]; then
      # ステージ済み内容をチェック
      if git show ":$file" | grep -Eqi "$DANGEROUS_PATTERN"; then
        echo "$file" >> "$TEMP_FILE"
      fi
    fi
  done

  # 一時ファイルから結果を読み込む
  if [ -s "$TEMP_FILE" ]; then
    echo "❌ エラー: 危険なDDLが含まれるマイグレーションを検出しました。"
    echo "対象ファイル:"
    while IFS= read -r file; do
      echo "  - $file"
    done < "$TEMP_FILE"
    echo ""
    echo "【対処例】"
    echo "- カラム名変更は RENAME COLUMN に書き換え（DROP/ADD を避ける）"
    echo "- 不要な TRUNCATE/DROP を削除するかデータ退避を検討"
    echo ""
    echo "⚠️  本当に破壊的変更が必要な場合でも、レビューのうえでコメントを残すなど慎重に対応してください。"
    rm -f "$TEMP_FILE"
    exit 1
  fi

  rm -f "$TEMP_FILE"
fi

exit 0
name: Check Migration Files

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  check-migrations:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 全履歴を取得（変更検出のため）
      
      - name: Check for database type changes
        id: check-db-types
        run: |
          # PRの場合とpushの場合で変更検出方法が異なる
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # PRの場合: baseとheadを比較
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            # Pushの場合: 前のコミットと比較
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.event.after }}"
          fi
          
          # database.types.tsが変更されたかチェック
          DB_TYPES_CHANGED=$(git diff --name-only $BASE_SHA $HEAD_SHA | grep -E "^src/types/database\.types\.ts$" || true)
          
          if [ -n "$DB_TYPES_CHANGED" ]; then
            echo "db_types_changed=true" >> $GITHUB_OUTPUT
            echo "⚠️ src/types/database.types.ts が変更されました"
          else
            echo "db_types_changed=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Check for migration files
        id: check-migrations
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.event.after }}"
          fi
          
          # supabase/migrations/ に新しいファイルが追加されたかチェック
          NEW_MIGRATIONS=$(git diff --name-only --diff-filter=A $BASE_SHA $HEAD_SHA | grep -E "^supabase/migrations/.*\.sql$" || true)
          
          if [ -n "$NEW_MIGRATIONS" ]; then
            echo "new_migrations=true" >> $GITHUB_OUTPUT
            echo "✅ 新しいマイグレーションファイルが追加されました:"
            echo "$NEW_MIGRATIONS" | while read file; do
              echo "  - $file"
            done
          else
            echo "new_migrations=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Validate migration requirement
        run: |
          DB_TYPES_CHANGED="${{ steps.check-db-types.outputs.db_types_changed }}"
          NEW_MIGRATIONS="${{ steps.check-migrations.outputs.new_migrations }}"
          
          if [ "$DB_TYPES_CHANGED" == "true" ] && [ "$NEW_MIGRATIONS" == "false" ]; then
            echo "::error::❌ DB変更が検出されましたが、マイグレーションファイルが追加されていません！"
            echo ""
            echo "src/types/database.types.ts が変更されましたが、supabase/migrations/ に新しいマイグレーションファイルが追加されていません。"
            echo ""
            echo "【対処方法】"
            echo "1. MCPでSQLを実行した場合:"
            echo "   - Supabase Dashboard > Database > Migrations から最新のマイグレーションを取得"
            echo "   - supabase/migrations/{timestamp}_{name}.sql として保存"
            echo ""
            echo "2. または、CLIで取得:"
            echo "   bash .cursor/load-env.sh sh -c 'npx supabase db pull --linked'"
            echo ""
            echo "3. マイグレーションファイルをコミット:"
            echo "   git add supabase/migrations/"
            echo "   git commit -m 'chore: add migration file'"
            echo ""
            echo "詳細: docs/DEPLOYMENT.md の「5.1 DB変更時の手順」を参照"
            exit 1
          elif [ "$DB_TYPES_CHANGED" == "true" ] && [ "$NEW_MIGRATIONS" == "true" ]; then
            echo "✅ DB変更とマイグレーションファイルの両方が検出されました"
          else
            echo "ℹ️ DB変更は検出されませんでした（スキップ）"
          fi


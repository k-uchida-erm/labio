name: Record DB Changes to Notion

on:
  push:
    branches: [main, develop]
    paths:
      - 'supabase/migrations/**/*.sql'

jobs:
  record-to-notion:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect new migrations
        id: detect-migrations
        run: |
          BASE_SHA="${{ github.event.before }}"
          HEAD_SHA="${{ github.event.after }}"

          NEW_MIGRATIONS=$(git diff --name-only --diff-filter=A "$BASE_SHA" "$HEAD_SHA" | grep -E "^supabase/migrations/.*\.sql$" || true)

          if [ -n "$NEW_MIGRATIONS" ]; then
            echo "migrations<<EOF" >> "$GITHUB_OUTPUT"
            echo "$NEW_MIGRATIONS" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Notion pages
        if: steps.detect-migrations.outputs.migrations != ''
        env:
          NOTION_API_TOKEN: ${{ secrets.NOTION_API_TOKEN }}
          NOTION_DATABASE_ID: 2c0b7adc-d6a4-806a-87ae-c450d3ea60b3
        run: |
          echo "${{ steps.detect-migrations.outputs.migrations }}" | while IFS= read -r migration_file; do
            [ -z "$migration_file" ] && continue
            
            filename=$(basename "$migration_file" .sql)
            timestamp=$(echo "$filename" | cut -d'_' -f1)
            name=$(echo "$filename" | cut -d'_' -f2-)
            
            branch="${{ github.ref_name }}"
            commit_sha="${{ github.sha }}"
            author="${{ github.actor }}"
            
            # ISO8601 timestamp (UTC, now)
            now_iso=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            
            # Migration timestampã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆYYYYMMDDHHMMSSå½¢å¼ï¼‰
            if [ ${#timestamp} -eq 14 ]; then
              migration_date="${timestamp:0:4}-${timestamp:4:2}-${timestamp:6:2}T${timestamp:8:2}:${timestamp:10:2}:${timestamp:12:2}Z"
            else
              migration_date="$now_iso"
            fi
            
            # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’è§£æã—ã¦æ—¥æœ¬èªè¦ç´„ã‚’ç”Ÿæˆ
            summary=""
            if [ -f "$migration_file" ]; then
              # CREATE TABLEã‚’æ¤œå‡ºï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«åã®ã¿æŠ½å‡ºï¼‰
              create_tables=$(grep -iE "^\s*create\s+table" "$migration_file" | sed -E 's/.*"public"\."([^"]+)".*/\1/' | sort -u | tr '\n' ',' | sed 's/,$//')
              if [ -n "$create_tables" ]; then
                summary="${summary}ğŸ“Š **ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ**: ${create_tables}\n\n"
              fi
              
              # ALTER TABLEã‚’æ¤œå‡ºï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«åã®ã¿æŠ½å‡ºã€é‡è¤‡é™¤å»ï¼‰
              alter_tables=$(grep -iE "^\s*alter\s+table" "$migration_file" | sed -E 's/.*"public"\."([^"]+)".*/\1/' | sort -u | tr '\n' ',' | sed 's/,$//')
              if [ -n "$alter_tables" ]; then
                summary="${summary}ğŸ”§ **ãƒ†ãƒ¼ãƒ–ãƒ«å¤‰æ›´**: ${alter_tables}\n\n"
              fi
              
              # CREATE INDEXã‚’æ¤œå‡ºï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åã®ã¿æŠ½å‡ºã€æœ€åˆã®10ä»¶ã®ã¿ï¼‰
              index_count=$(grep -iE "^\s*create\s+(unique\s+)?index" "$migration_file" | wc -l | tr -d ' ')
              create_indexes=$(grep -iE "^\s*create\s+(unique\s+)?index" "$migration_file" | sed -E 's/.*create\s+(unique\s+)?index\s+"?([^"\s(]+)"?.*/\2/i' | sort -u | head -10 | tr '\n' ',' | sed 's/,$//')
              if [ -n "$create_indexes" ] && [ "$create_indexes" != "create" ] && [ "$create_indexes" != "index" ] && [ "$create_indexes" != "unique" ]; then
                if [ "$index_count" -gt 10 ]; then
                  summary="${summary}ğŸ“‡ **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ**: ${create_indexes}... (ä»–$((index_count - 10))ä»¶)\n\n"
                else
                  summary="${summary}ğŸ“‡ **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ**: ${create_indexes}\n\n"
                fi
              fi
              
              # CREATE FUNCTIONã‚’æ¤œå‡ºï¼ˆé–¢æ•°åã®ã¿æŠ½å‡ºï¼‰
              create_functions=$(grep -iE "^\s*create\s+(or\s+replace\s+)?function" "$migration_file" | sed -E 's/.*"public"\."([^"]+)".*/\1/' | sort -u | tr '\n' ',' | sed 's/,$//')
              if [ -n "$create_functions" ]; then
                summary="${summary}âš™ï¸ **é–¢æ•°ä½œæˆ**: ${create_functions}\n\n"
              fi
              
              # CREATE TRIGGERã‚’æ¤œå‡ºï¼ˆãƒˆãƒªã‚¬ãƒ¼åã®ã¿æŠ½å‡ºï¼‰
              create_triggers=$(grep -iE "^\s*create\s+trigger" "$migration_file" | sed -E 's/.*create\s+trigger\s+"?([^"\s.]+)"?.*/\1/i' | sort -u | tr '\n' ',' | sed 's/,$//')
              if [ -n "$create_triggers" ] && [ "$create_triggers" != "create" ] && [ "$create_triggers" != "trigger" ]; then
                summary="${summary}ğŸ¯ **ãƒˆãƒªã‚¬ãƒ¼ä½œæˆ**: ${create_triggers}\n\n"
              fi
              
              # DROPã‚’æ¤œå‡º
              drop_items=$(grep -iE "^\s*drop\s+(table|index|function|trigger)" "$migration_file" | sed -E 's/.*"public"\."([^"]+)".*/\1/' | sort -u | tr '\n' ',' | sed 's/,$//')
              if [ -n "$drop_items" ]; then
                summary="${summary}ğŸ—‘ï¸ **å‰Šé™¤**: ${drop_items}\n\n"
              fi
              
              # è¦ç´„ãŒç©ºã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
              if [ -z "$summary" ]; then
                summary="ğŸ“ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚\n"
              fi
            else
              summary="ğŸ“ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚\n"
            fi
            
            echo "ğŸ“ Creating Notion page for: $name"
            
            # è¦ç´„ã‚’JSONã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆæ”¹è¡Œã¯\nã¨ã—ã¦ä¿æŒï¼‰
            summary_escaped=$(echo -e "$summary" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
            
            # childrenãƒ–ãƒ­ãƒƒã‚¯ã‚’æ§‹ç¯‰ï¼ˆè¦ç´„ã‚’paragraphãƒ–ãƒ­ãƒƒã‚¯ã¨ã—ã¦è¿½åŠ ï¼‰
            if [ -n "$summary" ]; then
              children_block=",\"children\":[{\"object\":\"block\",\"type\":\"paragraph\",\"paragraph\":{\"rich_text\":[{\"type\":\"text\",\"text\":{\"content\":\"$summary_escaped\"}}]}}]"
            else
              children_block=""
            fi
            
            curl -X POST https://api.notion.com/v1/pages \
              -H "Authorization: Bearer $NOTION_API_TOKEN" \
              -H "Content-Type: application/json" \
              -H "Notion-Version: 2022-06-28" \
              -d "{
                \"parent\": {
                  \"type\": \"database_id\",
                  \"database_id\": \"$NOTION_DATABASE_ID\"
                },
                \"properties\": {
                  \"Migration File\": {
                    \"title\": [
                      { \"text\": { \"content\": \"$name\" } }
                    ]
                  },
                  \"Timestamp\": {
                    \"date\": { \"start\": \"$migration_date\" }
                  },
                  \"Branch\": {
                    \"rich_text\": [
                      { \"text\": { \"content\": \"$branch\" } }
                    ]
                  },
                  \"Commit SHA\": {
                    \"rich_text\": [
                      { \"text\": { \"content\": \"$commit_sha\" } }
                    ]
                  },
                  \"Author\": {
                    \"rich_text\": [
                      { \"text\": { \"content\": \"$author\" } }
                    ]
                  }
                }${children_block}
              }" || echo "âš ï¸ Failed to create Notion page for $name"
          done


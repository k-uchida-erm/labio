# Activity機能 仕様書

## 1. 概要

### 1.1 目的

projectに紐づくActivity（タスク、実験ノート、質問、レビュー、面談など）を管理する機能を提供する。

### 1.2 Activityとは

Activityは研究活動のログ単位。他のタスク管理ツールでのissueに相当し、projectのデータベースとして機能する。

### 1.3 スコープ

**含まれるもの:**

- Activity CRUD（作成・読取・更新・削除）
- ステータス管理（Todo / In Progress / In Review / Done）
- タイプ管理（タスク / 実験ノート / 質問 / レビュー / 面談 / メモ）
- タグ付け
- コメント機能
- 添付ファイル
- マルチビュー（List / Kanban）

**含まれないもの（将来対応）:**

- Ganttビュー
- Calendarビュー
- Storyビュー
- AI要約機能

### 1.4 関連仕様書

- [DBスキーマ設計](../database/schema.md) - activities, tags, activity_tags, comments, attachments
- [RLSポリシー設計](../database/rls-policies.md) - activities関連のRLS
- [トリガー・関数設計](../database/triggers-functions.md) - Activity関連トリガー
- [API設計](../api/api-design.md) - 実装方式の選択基準

---

## 2. 機能要件

### 2.1 Activity CRUD

#### FR-ACT-001: Activity作成

**説明**: ユーザーが新しいActivityを作成できる

**受入基準**:

- [ ] タイトルは必須（1文字以上200文字以内）
- [ ] 説明（Markdown）はオプション（最大10000文字）
- [ ] タイプを選択できる（デフォルト: タスク）
- [ ] ステータスはデフォルトでTodo
- [ ] 期限日を設定できる（オプション）
- [ ] タグを複数設定できる（オプション）
- [ ] 作成者が自動的に記録される
- [ ] 作成日時が自動的に記録される
- [ ] sequence_numberが自動設定される（Project内で連番、1から始まる）
- [ ] 表示IDが自動生成される（`{projectKey}-{sequenceNumber}`形式、例: `PINN-1`）
- [ ] positionが自動設定される（同じproject_idとstatusの最後尾）

**権限**:
- Labメンバーは自分のprojectにActivityを作成可能
- 管理者はどのprojectにも作成可能

#### FR-ACT-002: Activity一覧表示

**説明**: projectに紐づくActivityを一覧表示できる

**受入基準**:

- [ ] Listビューで表示できる
- [ ] Kanbanビューで表示できる
- [ ] ステータスでフィルタリングできる
- [ ] タイプでフィルタリングできる
- [ ] タグでフィルタリングできる
- [ ] 検索（タイトル、説明）ができる
- [ ] ソート（作成日、期限日、更新日、position）ができる
- [ ] 削除済み（deleted_at IS NOT NULL）は表示されない
- [ ] ページネーションまたは無限スクロールで表示

**権限**:
- Labメンバーは全Activityを閲覧可能

#### FR-ACT-003: Activity詳細表示

**説明**: Activityの詳細情報を表示できる

**受入基準**:

- [ ] タイトル、説明、タイプ、ステータスを表示
- [ ] 期限日、作成日、更新日、開始日、完了日を表示
- [ ] 作成者を表示
- [ ] タグを表示
- [ ] コメント一覧を表示（スレッド形式）
- [ ] 添付ファイル一覧を表示
- [ ] 見積もり時間・実績時間を表示（オプション）

**権限**:
- Labメンバーは全Activityの詳細を閲覧可能

#### FR-ACT-004: Activity更新

**説明**: Activityの情報を更新できる

**受入基準**:

- [ ] タイトル、説明を編集できる
- [ ] タイプを変更できる
- [ ] ステータスを変更できる
- [ ] 期限日を変更・削除できる
- [ ] タグを追加・削除できる
- [ ] 見積もり時間・実績時間を設定できる
- [ ] 更新日時が自動的に記録される

**権限**:
- 管理者は全Activityを編集可能
- 作成者は自分のActivityを編集可能

#### FR-ACT-005: Activity削除

**説明**: Activityを削除できる

**受入基準**:

- [ ] ソフトデリート（deleted_atに日時を設定）
- [ ] 削除確認ダイアログを表示
- [ ] 削除後は一覧に表示されない
- [ ] 削除後もコメント・添付ファイルは保持される

**権限**:
- 管理者は全Activityを削除可能
- 作成者は自分のActivityを削除可能

### 2.2 ステータス管理

#### FR-ACT-006: ステータス変更

**説明**: Activityのステータスをワークフローに沿って変更できる

**受入基準**:

- [ ] Todo → In Progress: started_atが自動設定（トリガー）
- [ ] In Progress → In Review: 変更可能
- [ ] In Review → Done: completed_atが自動設定（トリガー）
- [ ] Done → Todo: completed_atがクリア（トリガー）
- [ ] Kanbanでドラッグ&ドロップで変更可能
- [ ] ステータス変更時にpositionが再計算される（トリガー）

**権限**:
- 管理者は全Activityのステータスを変更可能
- 作成者は自分のActivityのステータスを変更可能

### 2.3 タグ管理

#### FR-ACT-007: タグ管理

**説明**: Activityにタグを付けて分類できる

**受入基準**:

- [ ] 既存タグを選択して追加できる
- [ ] 新規タグを作成して追加できる（Lab単位）
- [ ] タグの色を設定できる（HEXカラーコード）
- [ ] タグ名はLab内で一意（最大50文字）
- [ ] タグを削除できる（管理者のみ）
- [ ] タグでフィルタリングできる
- [ ] 1つのActivityに複数タグを設定可能

**権限**:
- Labメンバーはタグを作成可能
- 管理者のみタグを編集・削除可能

### 2.4 コメント機能

#### FR-ACT-008: コメント機能

**説明**: Activityにコメントを追加できる

**受入基準**:

- [ ] Markdown形式でコメントを投稿できる（最大5000文字）
- [ ] コメントを編集できる（作成者のみ）
- [ ] コメントを削除できる（作成者または管理者）
- [ ] コメントに返信できる（スレッド形式）
- [ ] コメントに添付ファイルを追加できる
- [ ] コメントの作成日時・更新日時を表示
- [ ] 削除済みコメントは表示されない（deleted_at IS NOT NULL）

**権限**:
- Labメンバーはコメント可能
- 作成者のみ自分のコメントを編集可能
- 作成者または管理者はコメントを削除可能

### 2.5 添付ファイル

#### FR-ACT-009: 添付ファイル

**説明**: Activityに関連ファイルを添付できる

**受入基準**:

- [ ] ファイルをアップロードできる（Supabase Storage）
- [ ] 画像はプレビュー表示
- [ ] ファイルをダウンロードできる
- [ ] ファイルを削除できる（アップロード者または管理者）
- [ ] ファイルサイズ制限: 10MB/ファイル
- [ ] ファイル名、サイズ、MIMEタイプを表示
- [ ] ActivityまたはCommentに添付可能

**権限**:
- Activityを編集可能なユーザーは添付可能
- アップロード者または管理者は削除可能

### 2.6 ビュー機能

#### FR-ACT-010: Kanbanビュー

**説明**: Activityをカンバン形式で表示・操作できる

**受入基準**:

- [ ] ステータスごとにカラムを表示（Todo / In Progress / In Review / Done）
- [ ] ドラッグ&ドロップでステータス変更
- [ ] ドラッグ&ドロップで順序変更（同じステータス内）
- [ ] カード上でタイトル、タイプ、期限、タグを表示
- [ ] カラムごとのActivity数を表示
- [ ] カラム内でソート可能

---

## 3. 非機能要件

### 3.1 パフォーマンス

#### NFR-ACT-001: パフォーマンス

- Activity一覧取得: 500ms以下（100件まで）
- Activity作成: 300ms以下
- ステータス変更: 200ms以下
- コメント追加: 200ms以下

### 3.2 リアルタイム

#### NFR-ACT-002: リアルタイム更新

- 他ユーザーの変更がリアルタイムで反映される
- Supabase Realtimeを使用
- Activityの作成・更新・削除を通知
- コメントの追加を通知

### 3.3 データ整合性

#### NFR-ACT-003: データ整合性

- Activity削除時、関連するコメント・添付ファイルもソフトデリート（トリガー）
- project削除時、関連するActivityもソフトデリート（トリガー）
- ステータス変更時に自動的に日時を設定（トリガー）

---

## 4. データモデル

### 4.1 Activityステータス

| ステータス | 説明 |
|-----------|------|
| `todo` | 未着手 |
| `in_progress` | 進行中 |
| `in_review` | レビュー中 |
| `done` | 完了 |

### 4.2 Activityタイプ

| タイプ | 説明 |
|-------|------|
| `task` | タスク |
| `experiment` | 実験ノート |
| `question` | 質問 |
| `review` | レビュー依頼 |
| `meeting` | 面談・ゼミ |
| `note` | メモ・その他 |

### 4.3 主要フィールド

| フィールド | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| `id` | UUID | ○ | 一意識別子 |
| `lab_id` | UUID | ○ | Lab ID |
| `project_id` | UUID | ○ | Project ID |
| `sequence_number` | INTEGER | ○ | Project内での連番（1から始まる、自動設定） |
| `title` | TEXT | ○ | タイトル（1-200文字） |
| `description` | TEXT | - | 説明（Markdown、最大10000文字） |
| `type` | activity_type | ○ | タイプ（デフォルト: task） |
| `status` | activity_status | ○ | ステータス（デフォルト: todo） |
| `due_date` | TIMESTAMPTZ | - | 期限日 |
| `started_at` | TIMESTAMPTZ | - | 開始日時（自動設定） |
| `completed_at` | TIMESTAMPTZ | - | 完了日時（自動設定） |
| `estimated_hours` | DECIMAL(5,2) | - | 見積もり時間 |
| `actual_hours` | DECIMAL(5,2) | - | 実績時間 |
| `position` | INTEGER | ○ | 表示順序（自動設定） |
| `created_by` | UUID | ○ | 作成者ID |
| `created_at` | TIMESTAMPTZ | ○ | 作成日時 |
| `updated_at` | TIMESTAMPTZ | ○ | 更新日時（自動更新） |
| `deleted_at` | TIMESTAMPTZ | - | 削除日時（ソフトデリート） |

---

## 5. テスト仕様

### 5.1 単体テスト

#### TC-ACT-001: Activity作成

**前提条件**:
- ユーザーがLabメンバーとして認証されている
- projectが存在する

**テストケース**:

| ケース | 入力 | 期待結果 |
|-------|------|---------|
| TC-ACT-001-1 | タイトルのみ | Activityが作成され、デフォルト値が設定される（status: todo, type: task） |
| TC-ACT-001-2 | タイトル + 説明 + タグ | Activityが作成され、説明とタグが関連付けられる |
| TC-ACT-001-3 | タイトルが空 | バリデーションエラー |
| TC-ACT-001-4 | タイトルが200文字超過 | バリデーションエラー |
| TC-ACT-001-5 | 説明が10000文字超過 | バリデーションエラー |
| TC-ACT-001-6 | 存在しないproject_id | エラー（PROJECT_NOT_FOUND） |
| TC-ACT-001-7 | 非メンバーが作成 | エラー（PERMISSION_DENIED） |

#### TC-ACT-002: ステータス変更

**前提条件**:
- Activityが存在する

**テストケース**:

| ケース | 入力 | 期待結果 |
|-------|------|---------|
| TC-ACT-002-1 | Todo → In Progress | started_atが自動設定される |
| TC-ACT-002-2 | In Progress → Done | completed_atが自動設定される |
| TC-ACT-002-3 | Done → Todo | completed_atがNULLになる |
| TC-ACT-002-4 | 同じステータスに変更 | 日時は変更されない |
| TC-ACT-002-5 | 非作成者が変更 | エラー（PERMISSION_DENIED） |

#### TC-ACT-003: Activity削除

**前提条件**:
- Activityが存在する

**テストケース**:

| ケース | 入力 | 期待結果 |
|-------|------|---------|
| TC-ACT-003-1 | ソフトデリート | deleted_atが設定され、一覧に表示されない |
| TC-ACT-003-2 | 削除済みActivityの取得 | エラー（ACTIVITY_NOT_FOUND） |
| TC-ACT-003-3 | 非作成者が削除 | エラー（PERMISSION_DENIED） |

#### TC-ACT-004: タグ管理

**前提条件**:
- Labが存在する

**テストケース**:

| ケース | 入力 | 期待結果 |
|-------|------|---------|
| TC-ACT-004-1 | 新規タグ作成 | タグが作成され、Lab内で一意 |
| TC-ACT-004-2 | 既存タグ名で作成 | エラー（TAG_ALREADY_EXISTS） |
| TC-ACT-004-3 | Activityにタグ追加 | タグが関連付けられる |
| TC-ACT-004-4 | Activityからタグ削除 | タグの関連付けが削除される |
| TC-ACT-004-5 | タグ名が50文字超過 | バリデーションエラー |

#### TC-ACT-005: コメント機能

**前提条件**:
- Activityが存在する

**テストケース**:

| ケース | 入力 | 期待結果 |
|-------|------|---------|
| TC-ACT-005-1 | コメント追加 | コメントが作成される |
| TC-ACT-005-2 | コメント編集（作成者） | コメントが更新される |
| TC-ACT-005-3 | コメント編集（非作成者） | エラー（PERMISSION_DENIED） |
| TC-ACT-005-4 | コメント削除（作成者） | コメントがソフトデリートされる |
| TC-ACT-005-5 | コメントに返信 | スレッド形式で表示される |
| TC-ACT-005-6 | コメントが5000文字超過 | バリデーションエラー |

#### TC-ACT-006: 添付ファイル

**前提条件**:
- Activityが存在する

**テストケース**:

| ケース | 入力 | 期待結果 |
|-------|------|---------|
| TC-ACT-006-1 | ファイルアップロード | ファイルがSupabase Storageに保存される |
| TC-ACT-006-2 | 10MB超過ファイル | エラー（FILE_TOO_LARGE） |
| TC-ACT-006-3 | ファイル削除（アップロード者） | ファイルが削除される |
| TC-ACT-006-4 | ファイル削除（非アップロード者） | エラー（PERMISSION_DENIED） |

### 5.2 統合テスト

#### TC-ACT-007: Activity作成フロー

**前提条件**:
- ユーザーがLabメンバーとして認証されている
- projectが存在する

**テスト手順**:
1. Activity作成APIを呼び出す
2. 作成されたActivityを取得
3. 一覧に表示されることを確認
4. 詳細ページで表示されることを確認

**期待結果**:
- Activityが正常に作成される
- デフォルト値が設定される
- 一覧・詳細で表示される

#### TC-ACT-008: Kanbanドラッグ&ドロップ

**前提条件**:
- Activityが存在する
- Kanbanビューが表示されている

**テスト手順**:
1. Activityカードをドラッグ
2. 別のステータスカラムにドロップ
3. ステータス変更APIを呼び出す
4. 位置が更新されることを確認

**期待結果**:
- ステータスが変更される
- positionが再計算される
- 日時が自動設定される（該当する場合）

### 5.3 E2Eテスト

#### TC-ACT-E2E-001: Activity作成フロー

**前提条件**:
- ユーザーがログインしている
- projectページが表示されている

**テスト手順**:
1. 「Add Activity」ボタンをクリック
2. タイトルを入力
3. タイプを選択
4. 「作成」ボタンをクリック
5. 一覧に表示されることを確認

**期待結果**:
- Activityが作成される
- 一覧に表示される
- エラーメッセージが表示されない

#### TC-ACT-E2E-002: Kanbanドラッグ&ドロップ

**前提条件**:
- ユーザーがログインしている
- Kanbanビューが表示されている
- Activityが存在する

**テスト手順**:
1. Activityカードをドラッグ
2. 別のステータスカラムにドロップ
3. ステータスが変更されることを確認
4. ページをリロード
5. 変更が保持されることを確認

**期待結果**:
- ステータスが変更される
- 変更が永続化される
- UIが更新される

---

## 6. エラーハンドリング

| エラーコード | HTTPステータス | メッセージ | 対処法 |
|------------|---------------|-----------|--------|
| `ACTIVITY_NOT_FOUND` | 404 | Activityが見つかりません | IDを確認 |
| `PROJECT_NOT_FOUND` | 404 | projectが見つかりません | プロジェクトIDを確認 |
| `PERMISSION_DENIED` | 403 | この操作を行う権限がありません | ロールを確認 |
| `VALIDATION_ERROR` | 400 | 入力内容に誤りがあります | 入力値を確認 |
| `FILE_TOO_LARGE` | 400 | ファイルサイズが大きすぎます | 10MB以下のファイルを使用 |
| `TAG_ALREADY_EXISTS` | 409 | このタグ名は既に存在します | 別のタグ名を使用 |
| `UNAUTHORIZED` | 401 | 認証が必要です | ログインしてください |

---

## 7. バリデーション規則

### 7.1 Activity作成・更新

| フィールド | 規則 |
|-----------|------|
| `title` | 必須、1文字以上200文字以内 |
| `description` | オプション、最大10000文字 |
| `type` | 必須、enum値（task, experiment, question, review, meeting, note） |
| `status` | 必須、enum値（todo, in_progress, in_review, done） |
| `due_date` | オプション、有効な日時 |
| `estimated_hours` | オプション、0以上1000以下 |
| `actual_hours` | オプション、0以上1000以下 |

### 7.2 タグ作成

| フィールド | 規則 |
|-----------|------|
| `name` | 必須、1文字以上50文字以内、Lab内で一意 |
| `color` | 必須、HEXカラーコード（#RRGGBB形式） |

### 7.3 コメント作成

| フィールド | 規則 |
|-----------|------|
| `content` | 必須、1文字以上5000文字以内 |
| `parent_id` | オプション、存在するコメントID |

### 7.4 添付ファイル

| 項目 | 規則 |
|-----|------|
| ファイルサイズ | 10MB以下 |
| MIMEタイプ | 制限なし（画像、PDF、テキスト等） |

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 変更者 |
|------|-----------|---------|--------|
| 2024-12-02 | 1.0 | 初版作成 | - |

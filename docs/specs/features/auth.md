# 認証機能 仕様書

## 1. 概要

### 1.1 目的

Labioにおけるユーザー認証・認可機能を提供する。

### 1.2 スコープ

**含まれるもの:**

- サインアップ（メール/パスワード）
- ログイン（メール/パスワード）
- ログアウト
- パスワードリセット
- セッション管理
- プロフィール管理

**含まれないもの（将来対応）:**

- OAuth認証（Google, GitHub等）
- マジックリンク認証
- 2要素認証（2FA）

### 1.3 関連仕様書

- [DBスキーマ設計](../database/schema.md) - profilesテーブル
- [RLSポリシー設計](../database/rls-policies.md) - profilesのRLS
- [トリガー・関数設計](../database/triggers-functions.md) - handle_new_user
- [API設計](../api/api-design.md) - 実装方式の選択基準

---

## 2. 機能要件

### 2.1 認証

#### FR-AUTH-001: サインアップ

**説明**: 新規ユーザーがメールアドレスとパスワードでアカウントを作成できる

**受入基準**:

- [ ] メールアドレスとパスワードでサインアップできる
- [ ] パスワードは8文字以上
- [ ] パスワードには英字と数字を含める必要がある
- [ ] 重複するメールアドレスはエラー
- [ ] サインアップ後、確認メールが送信される
- [ ] メール確認後、ログイン可能になる
- [ ] プロフィールが自動作成される（トリガー）
- [ ] 表示名はオプション（最大50文字）

**権限**:
- 誰でもサインアップ可能

#### FR-AUTH-002: ログイン

**説明**: 登録済みユーザーがメールアドレスとパスワードでログインできる

**受入基準**:

- [ ] 正しい認証情報でログインできる
- [ ] 誤った認証情報ではエラーメッセージを表示
- [ ] メール未確認の場合はエラーメッセージを表示
- [ ] ログイン後、ダッシュボードにリダイレクト
- [ ] セッションがブラウザに保存される（Cookie）
- [ ] 複数デバイスでの同時ログインが可能

**権限**:
- 登録済みユーザーのみログイン可能

#### FR-AUTH-003: ログアウト

**説明**: ログイン中のユーザーがログアウトできる

**受入基準**:

- [ ] ログアウトボタンでセッションが破棄される
- [ ] ログアウト後、ログインページにリダイレクト
- [ ] ログアウト後、認証が必要なページにアクセスできない
- [ ] すべてのデバイスでセッションが破棄される（オプション）

**権限**:
- ログイン中のユーザーのみログアウト可能

#### FR-AUTH-004: パスワードリセット

**説明**: パスワードを忘れたユーザーが新しいパスワードを設定できる

**受入基準**:

- [ ] メールアドレスを入力してリセットメールを送信できる
- [ ] リセットリンクから新しいパスワードを設定できる
- [ ] リセットリンクには有効期限がある（1時間）
- [ ] パスワード変更後、自動的にログイン状態になる
- [ ] 新しいパスワードは8文字以上、英字と数字を含む必要がある

**権限**:
- 登録済みメールアドレスのみリセット可能

### 2.2 セッション管理

#### FR-AUTH-005: セッション管理

**説明**: ユーザーのログイン状態を適切に管理する

**受入基準**:

- [ ] セッションは7日間有効
- [ ] アクティブな操作でセッションが延長される
- [ ] 複数デバイスでの同時ログインが可能
- [ ] セッション切れ時は自動的にログインページへリダイレクト
- [ ] 認証が必要なページは自動的に保護される（Middleware）

**権限**:
- 認証済みユーザーのみアクセス可能

### 2.3 プロフィール管理

#### FR-AUTH-006: プロフィール管理

**説明**: ユーザーが自分のプロフィール情報を管理できる

**受入基準**:

- [ ] 表示名を変更できる（最大50文字）
- [ ] アバター画像をアップロードできる（Supabase Storage）
- [ ] アバター画像を削除できる
- [ ] メールアドレスは変更できない（将来対応）
- [ ] プロフィール情報が自動的に保存される
- [ ] 更新日時が自動的に記録される

**権限**:
- 自分のプロフィールのみ編集可能

#### FR-AUTH-007: パスワード変更

**説明**: ログイン中のユーザーがパスワードを変更できる

**受入基準**:

- [ ] 現在のパスワードを入力して確認
- [ ] 新しいパスワードを設定できる
- [ ] 新しいパスワードは8文字以上、英字と数字を含む必要がある
- [ ] パスワード変更後、すべてのデバイスで再ログインが必要（オプション）

**権限**:
- ログイン中のユーザーのみ変更可能

---

## 3. 非機能要件

### 3.1 セキュリティ

#### NFR-AUTH-001: セキュリティ

- パスワードはハッシュ化して保存（Supabase Auth）
- セッションはHTTPSで暗号化
- ログイン試行回数制限（レート制限）
- CSRF対策（Supabase Authで自動対応）

### 3.2 パフォーマンス

#### NFR-AUTH-002: パフォーマンス

- ログイン: 500ms以下
- サインアップ: 1000ms以下
- プロフィール取得: 200ms以下

---

## 4. データモデル

### 4.1 プロフィール

| フィールド | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| `id` | UUID | ○ | ユーザーID（auth.users.idと同一） |
| `email` | TEXT | ○ | メールアドレス |
| `display_name` | TEXT | - | 表示名（最大50文字） |
| `avatar_url` | TEXT | - | アバター画像URL（Supabase Storage） |
| `created_at` | TIMESTAMPTZ | ○ | 作成日時 |
| `updated_at` | TIMESTAMPTZ | ○ | 更新日時（自動更新） |

### 4.2 セッション

- Supabase Authで管理
- Cookieに保存
- 7日間有効
- 自動延長

---

## 5. テスト仕様

### 5.1 単体テスト

#### TC-AUTH-001: サインアップ

**前提条件**:
- 新規ユーザー

**テストケース**:

| ケース | 入力 | 期待結果 |
|-------|------|---------|
| TC-AUTH-001-1 | 有効なメール・パスワード | サインアップ成功、確認メール送信 |
| TC-AUTH-001-2 | 重複メールアドレス | エラー（EMAIL_ALREADY_EXISTS） |
| TC-AUTH-001-3 | パスワード7文字以下 | バリデーションエラー |
| TC-AUTH-001-4 | パスワードに英字なし | バリデーションエラー |
| TC-AUTH-001-5 | パスワードに数字なし | バリデーションエラー |
| TC-AUTH-001-6 | 無効なメールアドレス | バリデーションエラー |
| TC-AUTH-001-7 | 表示名50文字超過 | バリデーションエラー |

#### TC-AUTH-002: ログイン

**前提条件**:
- 登録済みユーザー

**テストケース**:

| ケース | 入力 | 期待結果 |
|-------|------|---------|
| TC-AUTH-002-1 | 正しい認証情報 | ログイン成功、セッション作成 |
| TC-AUTH-002-2 | 誤ったパスワード | エラー（INVALID_CREDENTIALS） |
| TC-AUTH-002-3 | 存在しないメールアドレス | エラー（INVALID_CREDENTIALS） |
| TC-AUTH-002-4 | メール未確認 | エラー（EMAIL_NOT_CONFIRMED） |
| TC-AUTH-002-5 | ログイン後、プロフィールが取得できる | プロフィール情報が返される |

#### TC-AUTH-003: ログアウト

**前提条件**:
- ログイン中のユーザー

**テストケース**:

| ケース | 入力 | 期待結果 |
|-------|------|---------|
| TC-AUTH-003-1 | ログアウト実行 | セッション破棄、ログインページへリダイレクト |
| TC-AUTH-003-2 | ログアウト後、認証ページアクセス | エラー（UNAUTHORIZED） |

#### TC-AUTH-004: パスワードリセット

**前提条件**:
- 登録済みユーザー

**テストケース**:

| ケース | 入力 | 期待結果 |
|-------|------|---------|
| TC-AUTH-004-1 | 有効なメールアドレス | リセットメール送信 |
| TC-AUTH-004-2 | 存在しないメールアドレス | エラー（EMAIL_NOT_FOUND） |
| TC-AUTH-004-3 | 有効なリセットリンク | パスワード変更可能 |
| TC-AUTH-004-4 | 期限切れリセットリンク | エラー（TOKEN_EXPIRED） |
| TC-AUTH-004-5 | 新しいパスワード7文字以下 | バリデーションエラー |

#### TC-AUTH-005: プロフィール更新

**前提条件**:
- ログイン中のユーザー

**テストケース**:

| ケース | 入力 | 期待結果 |
|-------|------|---------|
| TC-AUTH-005-1 | 表示名変更 | プロフィールが更新される |
| TC-AUTH-005-2 | アバター画像アップロード | 画像が保存され、URLが返される |
| TC-AUTH-005-3 | 表示名50文字超過 | バリデーションエラー |
| TC-AUTH-005-4 | 他ユーザーのプロフィール更新 | エラー（PERMISSION_DENIED） |

### 5.2 統合テスト

#### TC-AUTH-006: 認証フロー

**前提条件**:
- 新規ユーザー

**テスト手順**:
1. サインアップ
2. 確認メール受信
3. メール確認
4. ログイン
5. プロフィール取得
6. ログアウト

**期待結果**:
- すべてのステップが正常に完了する
- セッションが適切に管理される

#### TC-AUTH-007: セッション管理

**前提条件**:
- ログイン中のユーザー

**テスト手順**:
1. 認証が必要なページにアクセス
2. セッションが有効であることを確認
3. セッションを破棄
4. 認証が必要なページにアクセス
5. ログインページへリダイレクトされることを確認

**期待結果**:
- セッションが適切に管理される
- 認証が必要なページが保護される

### 5.3 E2Eテスト

#### TC-AUTH-E2E-001: サインアップ・ログインフロー

**前提条件**:
- 新規ユーザー

**テスト手順**:
1. サインアップページにアクセス
2. メールアドレス・パスワードを入力
3. 「サインアップ」ボタンをクリック
4. 確認メールを受信
5. メール内のリンクをクリック
6. ログインページにリダイレクト
7. メールアドレス・パスワードを入力
8. 「ログイン」ボタンをクリック
9. ダッシュボードにリダイレクトされることを確認

**期待結果**:
- サインアップ・ログインが正常に完了する
- ダッシュボードが表示される

#### TC-AUTH-E2E-002: パスワードリセットフロー

**前提条件**:
- 登録済みユーザー

**テスト手順**:
1. ログインページで「パスワードを忘れた場合」をクリック
2. メールアドレスを入力
3. 「リセットメール送信」ボタンをクリック
4. リセットメールを受信
5. メール内のリンクをクリック
6. 新しいパスワードを入力
7. 「パスワード変更」ボタンをクリック
8. 自動的にログイン状態になることを確認

**期待結果**:
- パスワードリセットが正常に完了する
- 新しいパスワードでログインできる

---

## 6. エラーハンドリング

| エラーコード | HTTPステータス | メッセージ | 対処法 |
|------------|---------------|-----------|--------|
| `EMAIL_ALREADY_EXISTS` | 409 | このメールアドレスは既に登録されています | ログインを試す |
| `INVALID_CREDENTIALS` | 401 | メールアドレスまたはパスワードが正しくありません | 認証情報を確認 |
| `EMAIL_NOT_CONFIRMED` | 403 | メールアドレスの確認が完了していません | 確認メールを確認 |
| `EMAIL_NOT_FOUND` | 404 | このメールアドレスは登録されていません | メールアドレスを確認 |
| `TOKEN_EXPIRED` | 401 | リセットリンクの有効期限が切れています | 再度リセットメールを送信 |
| `UNAUTHORIZED` | 401 | 認証が必要です | ログインしてください |
| `PERMISSION_DENIED` | 403 | この操作を行う権限がありません | 権限を確認 |
| `VALIDATION_ERROR` | 400 | 入力内容に誤りがあります | 入力値を確認 |

---

## 7. バリデーション規則

### 7.1 サインアップ

| フィールド | 規則 |
|-----------|------|
| `email` | 必須、有効なメールアドレス形式 |
| `password` | 必須、8文字以上、英字と数字を含む |
| `displayName` | オプション、最大50文字 |

### 7.2 ログイン

| フィールド | 規則 |
|-----------|------|
| `email` | 必須、有効なメールアドレス形式 |
| `password` | 必須 |

### 7.3 パスワードリセット

| フィールド | 規則 |
|-----------|------|
| `email` | 必須、有効なメールアドレス形式 |
| `newPassword` | 必須、8文字以上、英字と数字を含む |

### 7.4 プロフィール更新

| フィールド | 規則 |
|-----------|------|
| `displayName` | オプション、最大50文字 |
| `avatarUrl` | オプション、有効なURL |

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 変更者 |
|------|-----------|---------|--------|
| 2024-12-02 | 1.0 | 初版作成 | - |

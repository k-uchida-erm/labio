# RLSポリシー設計書

## 1. 概要

本ドキュメントでは、LabioのRow Level Security（RLS）ポリシーを定義する。

### 1.1 設計原則

- **デフォルト拒否**: RLS有効化後、明示的に許可しない限りアクセス不可
- **最小権限の原則**: 必要最小限の権限のみ付与
- **ロールベースアクセス**: Lab内でのロール（ownerかどうか）に基づく制御
- **パフォーマンス考慮**: 効率的なクエリのためのヘルパー関数を使用

### 1.2 ヘルパー関数

RLSポリシーで使用するヘルパー関数。実装時に参照する。

| 関数名                                   | 説明                                    | 戻り値  |
| ---------------------------------------- | --------------------------------------- | ------- |
| `auth.uid()`                             | 現在のユーザーIDを取得（Supabase提供）  | UUID    |
| `is_lab_member(target_lab_id)`           | 指定されたLabのメンバーかどうかを確認   | BOOLEAN |
| `is_lab_owner(target_lab_id)`            | 指定されたLabのownerかどうかを確認      | BOOLEAN |
| `is_project_assignee(target_project_id)` | 指定されたprojectの担当者かどうかを確認 | BOOLEAN |

---

## 2. テーブル別RLSポリシー

### 2.1 profiles（ユーザープロフィール）

| 操作       | 権限                                                                        |
| ---------- | --------------------------------------------------------------------------- |
| **SELECT** | 自分のプロフィールは常に閲覧可能。同じLabのメンバーのプロフィールも閲覧可能 |
| **INSERT** | 自分のプロフィールのみ作成可能（トリガーで自動作成）                        |
| **UPDATE** | 自分のプロフィールのみ更新可能                                              |
| **DELETE** | 自分のプロフィールのみ削除可能（通常は使用しない）                          |

### 2.2 labs（研究室/lab）

| 操作       | 権限                                                                 |
| ---------- | -------------------------------------------------------------------- |
| **SELECT** | 自分がメンバーのLabのみ閲覧可能（`deleted_at IS NULL`のもの）        |
| **INSERT** | 認証済みユーザーは誰でもLabを作成可能（作成者は自動的にownerになる） |
| **UPDATE** | ownerのみ更新可能                                                    |
| **DELETE** | ownerのみ削除可能（ソフトデリート）                                  |

### 2.3 lab_members（研究室メンバー）

| 操作       | 権限                                                                                              |
| ---------- | ------------------------------------------------------------------------------------------------- |
| **SELECT** | 同じLabのメンバー情報を閲覧可能                                                                   |
| **INSERT** | - Lab作成時に自分自身をownerとして追加可能<br>- ownerのみメンバーを追加可能                       |
| **UPDATE** | ownerのみis_ownerフラグを変更可能（ただし自分のownerフラグは変更不可）                            |
| **DELETE** | - ownerはメンバーを削除可能（ただし自分は削除不可）<br>- 自分自身はLabから退出可能（ownerを除く） |

### 2.4 lab_invitations（招待）

| 操作       | 権限                                                                             |
| ---------- | -------------------------------------------------------------------------------- |
| **SELECT** | - Labのownerは招待一覧を閲覧可能<br>- 招待されたユーザーは自分宛の招待を閲覧可能 |
| **INSERT** | ownerのみ招待可能                                                                |
| **UPDATE** | 招待されたユーザーのみステータス更新可能（承認/拒否、`pending`状態のみ）         |
| **DELETE** | ownerのみ招待を削除可能                                                          |

### 2.5 projects（project）

| 操作       | 権限                                                              |
| ---------- | ----------------------------------------------------------------- |
| **SELECT** | Labメンバーは全projectを閲覧可能（`deleted_at IS NULL`のもの）    |
| **INSERT** | ownerのみprojectを作成可能                                        |
| **UPDATE** | - ownerは全projectを編集可能<br>- 担当者は自分のprojectを編集可能 |
| **DELETE** | ownerのみ削除可能（ソフトデリート）                               |

### 2.6 activities（Activity）

| 操作       | 権限                                                                                 |
| ---------- | ------------------------------------------------------------------------------------ |
| **SELECT** | Labメンバーは全Activityを閲覧可能（`deleted_at IS NULL`のもの）                      |
| **INSERT** | - Labメンバーは自分のprojectにActivityを作成可能<br>- ownerはどのprojectにも作成可能 |
| **UPDATE** | - ownerは全Activity編集可能<br>- 作成者は自分のActivity編集可能                      |
| **DELETE** | - ownerは全Activity削除可能<br>- 作成者は自分のActivity削除可能                      |

### 2.7 tags（タグ）

| 操作       | 権限                        |
| ---------- | --------------------------- |
| **SELECT** | Labメンバーはタグを閲覧可能 |
| **INSERT** | Labメンバーはタグを作成可能 |
| **UPDATE** | ownerのみタグを編集可能     |
| **DELETE** | ownerのみタグを削除可能     |

### 2.8 activity_tags（Activity-タグ中間テーブル）

| 操作       | 権限                                             |
| ---------- | ------------------------------------------------ |
| **SELECT** | Activityを閲覧可能なユーザーはタグ関連も閲覧可能 |
| **INSERT** | Activityを編集可能なユーザーはタグを追加可能     |
| **DELETE** | Activityを編集可能なユーザーはタグを削除可能     |

### 2.9 comments（コメント）

| 操作       | 権限                                                                           |
| ---------- | ------------------------------------------------------------------------------ |
| **SELECT** | Activityを閲覧可能なユーザーはコメントも閲覧可能（`deleted_at IS NULL`のもの） |
| **INSERT** | Labメンバーはコメント可能                                                      |
| **UPDATE** | 作成者のみ編集可能                                                             |
| **DELETE** | - ownerは全コメント削除可能<br>- 作成者は自分のコメント削除可能                |

### 2.10 attachments（添付ファイル）

| 操作       | 権限                                                                 |
| ---------- | -------------------------------------------------------------------- |
| **SELECT** | 関連するActivity/Commentを閲覧可能なユーザーは添付ファイルも閲覧可能 |
| **INSERT** | 関連するActivity/Commentに書き込み権限があるユーザーは添付可能       |
| **DELETE** | - アップロード者は自分の添付ファイルを削除可能<br>- ownerは削除可能  |

### 2.11 ai_summaries（AI生成サマリー）

| 操作       | 権限                                                    |
| ---------- | ------------------------------------------------------- |
| **SELECT** | Labメンバーはサマリーを閲覧可能                         |
| **INSERT** | Labメンバーはサマリーを生成可能                         |
| **DELETE** | - 作成者は自分のサマリーを削除可能<br>- ownerは削除可能 |
